---
title: "d589_hfianalysis"
author: "Vidal Mendoza Tinoco (76236256)"
date: "2025-04-13"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

#load packages
library(sp)
library(sf)
library(spatstat)
library(rgbif)
library(ggplot2)
library(rnaturalearth)
library(rnaturalearthdata)
library(tidyverse)
library(raster)
library(mgcv)
```

```{r}
# load and view data
load("bc_bear_occurrences.Rda")
load("BC_Covariates.Rda")
summary(DATA)
``` 

### Visualize bear occurrences in BC

```{r}
# extract location columns
bears_loc <- occ_data[, c("decimalLongitude", "decimalLatitude", "month", "year")]
bears_loc_filtered <- subset(bears_loc, year %in% c(2020, 2021, 2022, 2023, 2024))

# create sf object
bears_sf <- st_as_sf(
  bears_loc_filtered,
  coords = c("decimalLongitude", "decimalLatitude"),
  crs = 4326  # WGS84 (longitude/latitude)
)

# BC Albers projection
bears_sf_proj <- st_transform(bears_sf, crs = 3005)

# extract x, y coordinates
coords <- st_coordinates(bears_sf_proj)

# extract BC window
window_sf <- st_as_sf(DATA$Window) # convert SpatialPolygons to Simple Features (sf)
window_proj <- st_transform(window_sf, crs = 3005) # ensure same CRS
window <- as.owin(window_proj) # convert to owin using sf object

# create ppp object
bears_ppp <- ppp(
  x = coords[,1],
  y = coords[,2],
  window = window
)

plot(bears_ppp, pch = 21, main = "Black bear occurrences in BC, 2024")
```

### Compare seasonal distributions

```{r}
# Define the seasons and corresponding colors
seasons <- list(
  winter = c(12, 1, 2),
  spring = c(3, 4, 5),
  summer = c(6, 7, 8),
  autumn = c(9, 10, 11)
)

# Create an empty list to store the ppp objects for each season
ppp_list <- list()

# Create an empty list to store the filtered data for each season
bears_sf_list <- list()

# Loop over seasons
for (i in 1:length(seasons)) {
  
  # Filter for each season
  season_name <- names(seasons)[i]
  season_months <- seasons[[i]]
  
  # Filter bears_loc_filtered by the season's months
  bears_loc_season <- bears_loc_filtered[bears_loc_filtered$month %in% season_months, ]
  
  # Print the number of observations for this season
  cat(season_name, ": ", nrow(bears_loc_season), " observations\n", sep="")
  
  # Create sf object for the filtered season
  bears_sf_season <- st_as_sf(
    bears_loc_season,
    coords = c("decimalLongitude", "decimalLatitude"),
    crs = 4326  # WGS84 (longitude/latitude)
  )
  
  # Transform to BC Albers projection
  bears_sf_season_proj <- st_transform(bears_sf_season, crs = 3005)
  
  # Store sf object in the list
  bears_sf_list[[season_name]] <- bears_sf_season_proj
  
  # Extract x, y coordinates
  coords <- st_coordinates(bears_sf_season_proj)
  
  # Create ppp object for each season
  suppressWarnings(
    bears_ppp_season <- ppp(
      x = coords[, 1],
      y = coords[, 2],
      window = window
    )
  )
  
  # Store ppp object in the list
  ppp_list[[season_name]] <- bears_ppp_season
}
```

```{r}
# Plot the four maps in a 2x2 grid
par(mfrow=c(2,2), mar=c(1,1,1,1))  # Set up a 2x2 plotting window

# Loop over ppp objects and plot them
for (i in 1:length(ppp_list)) {
  season_name <- names(ppp_list)[i]
  suppressWarnings(
    plot(ppp_list[[season_name]], main = paste(season_name, "(2024)"), pch = 21)
  )
}
```

### Looking at covariates

```{r}
par(mfrow=c(2,2), mar=c(1,1,1,1))  # Set up a 2x2 plotting window
plot(DATA$Elevation)
plot(DATA$Forest)
plot(DATA$HFI)
plot(DATA$Dist_Water)
```

```{r}
elev <- DATA$Elevation
cover <- DATA$Forest
dist_water <- DATA$Dist_Water
hfi <- DATA$HFI

```


```{r}
# intensity as a function of HFI (human footprint index)
par(mfrow=c(2,2), mar=c(2,2,2,2))
for (i in 1:length(ppp_list)) {
  season_name <- names(ppp_list)[i]
  rho <- rhohat(ppp_list[[season_name]], hfi) 
  plot(rho, xlim=c(0, max(hfi)), main = paste(season_name))
}
```  


### EDA  

```{r}
# HFI for bears locations

# im object to RasterLayer
im2raster <- function(im_obj) {
  # iamge to matrix
  m <- as.matrix(im_obj)
  # create raster object
  r <- raster(m)
  # range and extension
  ext <- c(im_obj$xrange[1] - im_obj$xstep/2,
           im_obj$xrange[2] + im_obj$xstep/2,
           im_obj$yrange[1] - im_obj$ystep/2,
           im_obj$yrange[2] + im_obj$ystep/2)
  extent(r) <- ext
  return(r)
}

# hfi to RasterLayer
hfi_raster <- im2raster(hfi)

# HFI in bear locations
bears_sf_proj$hfi_value <- extract(hfi_raster, bears_sf_proj)

summary(bears_sf_proj$hfi_value)
```  

**Interpretation:** The results suggest that most bear occurrences are found in areas with very low human footprints (values close to 0), which aligns with the expectation that bears are sensitive to human impact and tend to inhabit remote or undisturbed areas. The distribution is skewed to the right, indicating the presence of a few points in areas with higher HFIs that slightly elevate the mean, but do not change the fact that, overall, bears are predominantly detected in habitats with low human interference.  

```{r}
hist(bears_sf_proj$hfi_value, 
     main = "HFI distribution at bear locations", 
     xlab = "HFI",
     col = "lightblue", border = "grey")

```  

```{r}
hfi_values <- getValues(hfi_raster)

hist(hfi_values, 
     main = "Global distribution of HFI in BC", 
     xlab = "HFI",
     col = "lightgreen", border = "grey")
```  

### Model  

```{r}
hfi_matrix <- as.matrix(hfi)
media_hfi <- mean(as.vector(hfi_matrix), na.rm = TRUE)
cat("Mean HFI (without NA):", media_hfi, "\n")

# Impute NA values in HFI using the mean
hfi_clean <- eval.im( ifelse(is.na(hfi), media_hfi, hfi) )

summary(as.vector(as.matrix(hfi_clean)))

# model
mod_hfi_clean <- ppm(bears_ppp, ~ hfi, covariates = list(hfi = hfi_clean))
mod_hfi_clean
```  

**Interpretation:** The HFI object was processed into a raster image, which involves organizing the variable on a spatial grid in which each cell has a specific HFI value. The mean of all available values was then calculated (omitting the NAs) and obtained an approximate value of 0.09459. This mean represents a central measure of HFI in the analyzed region and is a global reflection of the conditions evaluated.  

Furthermore, to avoid problems arising from missing data in some cells, missing values were imputed using this same mean. By replacing the NAs with 0.09459, it is ensured that most cells in the raster share a very similar value, which is reflected in the statistical summary: both the median and the first and third quartiles are located around 0.09459. It is worth noting that, despite this homogeneity, some extreme values are observed, reaching up to 0.92381, indicating the presence of specific areas with significantly different conditions.  

With these processed data, a point process model (ppm) was fitted where intensity, defined as the logarithm of intensity, is modeled as a function of HFI. The model returns two coefficients: the intercept (approximately -20.606402) and the HFI coefficient (approximately 5.888651). The latter indicates a positive relationship: higher HFI values increase intensity, which translates into a higher probability of bear occurrence in those areas. In essence, although most of the raster presents very similar values, increases in HFI are associated with a substantial increase in bear occurrence intensity, reflecting the model's sensitivity to variations in this variable.  

In summary, these results highlight two key aspects: first, the imputation strategy generated a distribution highly concentrated around the mean, with a few exceptions; second, the positive relationship found in the model highlights that even modest variations in HFI can have a significant impact on bear presence.  

```{r}
# Predict the intensity in the study region
pred_intensity <- predict(mod_hfi_clean)

# Plot
plot(pred_intensity, main = "Predicted Intensity Map based on HFI")
points(bears_ppp, pch = 20, col = "red")
```  

**Interpretation:** The predicted intensity map shows that, based on the human footprint (HFI), most of the study area has very low intensities, indicating few expected events per unit area. Although the model shows a positive relationship between HFI and intensity, most HFI values are low, making the differences subtle. The overlay of actual occurrence points helps verify that, despite the reduced scale, the model captures spatial variation in areas with slight increases in HFI.

```{r}
mod_res_clean <- residuals(mod_hfi_clean, type = "pearson")

mod_res_clean$v[!is.finite(mod_res_clean$v)] <- NA

# Residuals
plot(mod_res_clean, main = "Model Residual Map (Pearson) - Imputed HFI", na.col = "transparent")
```  

**Interpretation:** The distribution of the residuals does not show large spatial patterns, which would indicate that, although there are specific variations, globally the inhomogeneous Poisson model with HFI imputes a reasonable fit, but there could be specific areas that require complementary analysis or the incorporation of more covariates to improve the fit.  


### Stational analysis  

```{r}
# model for each season (individually)
models_seasonal <- list()

for (season in names(ppp_list)) {
  models_seasonal[[season]] <- ppm(ppp_list[[season]], ~ hfi, covariates = list(hfi = hfi_clean))
  cat("Model for", season, ":\n")
  print(models_seasonal[[season]])
}
```  

**Interpretation:** First, the models for each season confirm that the coefficient associated with HFI is positive in all seasons. This implies that, regardless of the season, an increase in the human footprint is associated with an increase in the intensity (or rate) of bear occurrence. In other words, the higher the HFI value, the greater the probability of detecting bear presence.  

Looking at the differences between seasons, it is notable that the winter model presents a more negative intercept (approximately -24.9955) compared to those for spring (-22.0330), summer (-21.1619), and autumn (-22.1355). This indicates that, for a given HFI value, the logarithmic intensity in winter is predicted to be lower. However, the HFI coefficient in winter (6.6671) is the highest, suggesting that, although the base intensity is lower, the effect of an increase in HFI is more pronounced in this season.  

It is important to note that during the winter model fitting, a warning was issued stating that the fitting algorithm (glm) did not converge. This raises concerns about potential instability or complexity in the behavior of the data for that season, which may require further review or consideration of alternative estimation methods to obtain more reliable parameters.  

In summary, the results suggest that, in all cases, increasing human footprints are associated with greater intensity of bear occurrence, although slight seasonal variations are observed in the intensity base and in the sensitivity to changes in HFI. These findings highlight the importance of considering the temporal component when interpreting the relationship between anthropogenic conditions and bear occurrence.  


```{r}
# Combine the data from each season into a single data frame
bears_all <- do.call(rbind, lapply(names(bears_sf_list), function(season) {
  sf_season <- bears_sf_list[[season]]
  coords <- st_coordinates(sf_season)
  hfi_vals <- extract(hfi_raster, sf_season)
  data.frame(x = coords[, 1], y = coords[, 2],
             hfi_value = hfi_vals, season = season)
}))

# Convert "season" to a factor
bears_all$season <- as.factor(bears_all$season)

# Create a ppp object for the entire dataset using the defined study window.
bears_ppp_all <- ppp(
  x = bears_all$x,
  y = bears_all$y,
  window = window,
  marks = bears_all$season
)

# Check how many points remain in the ppp object
cat("Number of points in bears_ppp_all:", npoints(bears_ppp_all), "\n")

# Retrieve the marks from the ppp object (these correspond to the points kept after rejection)
current_marks <- marks(bears_ppp_all)

# Convert the marks into a data frame with the correct number of rows
marks(bears_ppp_all) <- data.frame(season = current_marks)

# Fit the combined model including the interaction between HFI and season.
mod_combined <- ppm(bears_ppp_all, ~ hfi * marks, 
                    covariates = list(hfi = hfi_clean))

# Display the model summary
mod_combined

```  

**Interpretation:** 

First, the bear data from each station was combined into a single dataset, generating a point-processing (PPP) object that incorporates seasonality as a marker. Problems were noted during this step, as some points were rejected for being located outside the study window, and duplicates were detected, resulting in 3,400 points for analysis.  

The combined model was fitted by including the interaction between HFI and the variable season (with autumn as the reference). This allows both the intercept and slope associated with HFI to vary by season. In autumn, the following relationship is observed:  

$$
\log(\lambda) = -22.2558 + 6.4079 \times \text{HFI}
$$

Meanwhile, in spring and summer, both the intercept and slope are adjusted, resulting in a slightly lower response to the HFI compared to autumn. In winter, although the intercept is lower, the slope increases significantly, implying that intensity responds more sensitively to changes in HFI.  

It is important to note that, during the fitting of the combined model, a warning was issued that the fitting algorithm (glm) did not converge, so it is suggested that the parameters be interpreted with caution, especially in winter.  

```{r}
# Each row represents one occurrence, so we assign count = 1 to each one
bears_all$count <- 1

# GAM model with a smooth function for hfi_value and a term for season
gam_model <- gam(count ~ s(hfi_value) + season, data = bears_all, family = poisson())

summary(gam_model)
```  

**Interpretation:** The fitted GAM model, which modeled the occurrence count (with 1 for each point) based on a smooth term for the variable hfi_value and a categorical effect of season, found no evidence of a significant effect for any of the predictors. The parametric coefficients associated with the intercept and seasons presented practically zero values, with relatively large standard errors and p-values of 1, indicating that, in this case, differences between seasons are not detectable.  

Similarly, the smooth term for hfi_value had an effective degree of freedom (edf) equal to 1 and a chi-square statistic of 0, suggesting that the smooth function behaves like a straight line without any significant variation. Taken together, these results indicate that, based on this formulation of the GAM model, no significant relationship is observed between human footprint or seasonality with the frequency of bear occurrences in the analyzed dataset.  

```{r}
mod_ppp <- ppm(bears_ppp_all, ~ polynom(hfi, degree = 2) + marks)
mod_ppp
```

**Interpretation:** The fitted model is a nonstationary multitype point process that uses second degree polynomial terms in the HFI variable along with fixed season effects (with autumn as the reference) to model the logarithmic function of bear occurrence intensity, expressed as

$$
\log(\lambda) = \beta_0 + \beta_1\,\text{HFI} + \beta_2\,\text{HFI}^2 + \text{season effects}
$$

In this case, the estimated intercept is -22.8075, with a linear coefficient for HFI of 11.7649 and a quadratic coefficient of -6.8904. These coefficients indicate that the relationship between the human footprint (HFI) and bear presence is curvilinear. For example, in an area where HFI is very low (say, 0.05), intensity (the bear appearance rate) is low, as HFI increases to a moderate value (say, 0.15), the positive influence of the linear term drives an increase in bear detections. However, as HFI continues to increase to high values (such as 0.8), the negative quadratic term comes into play, moderating and even reversing the effect, suggesting that in areas with high human activity, bears may avoid those areas and, therefore, their presence decreases.  

In addition, seasonal effects have been incorporated that adjust the base intensity additively. Compared to autumn (the reference category), the adjustments are very slight in spring, moderately positive in summer, and negative in winter. This implies that, for the same HFI value, the bear appearance rate may be higher in summer and lower in winter, reflecting the influence of seasonal conditions that add to the nonlinear HFI response.  

In summary, the model suggests that the relationship between HFI and bear presence is complex, in areas with slight increases in human activity, bear presence increases, but when the human footprint becomes very high, bear presence decreases, and this dynamic varies seasonally.    

